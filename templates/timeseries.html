<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsserier - Mat- og Symptombok</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/plotly.min.js"></script>
</head>
<body>
<nav>
    <div class="container">
        <a href="/">ğŸ  Hjem</a>
        <a href="/report">ğŸ“Š Rapport</a>
        <a href="/crosscorr">ğŸ”— Krysskorrelasjon</a>
        <a href="/meal-symptom-analysis">ğŸ“ˆ Analyse</a>
        <a href="/timeseries" class="active">â±ï¸ Tidsserier</a>
    </div>
</nav>

<div class="container">
    <h1>â±ï¸ Tidsserier for Hendelser</h1>
    <p>Visualisering av mÃ¥ltider og symptomer som tidsfunksjoner. Y-aksen viser 1 nÃ¥r hendelsen skjer og 0 ellers.</p>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ“… Velg tidsperiode</h2>
        </div>
        <div class="form-group">
            <label for="start-date">Startdato:</label>
            <input type="date" id="start-date" value="{{ .Start }}">
        </div>
        <div class="form-group">
            <label for="end-date">Sluttdato:</label>
            <input type="date" id="end-date" value="{{ .End }}">
        </div>
        <div class="form-group">
            <label for="tau">Tidskonstant (minutter, lavpassfilter):</label>
            <input type="number" id="tau" min="1" max="240" value="10" style="width: 80px;">
        </div>
        <button id="update-chart" class="btn btn-primary">ğŸ”„ Oppdater diagram</button>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ½ï¸ MÃ¥ltider - Tidsserie (etter type)</h2>
        </div>
        <div id="meal-chart" style="height: 500px;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ¤’ Symptomer - Tidsserie (etter type)</h2>
        </div>
        <div id="symptom-chart" style="height: 500px;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ“Š Kombinert visning - Alle typer</h2>
        </div>
        <div id="combined-chart" style="height: 600px;"></div>
    </div>
</div>

<script>
// Color palettes for different types
const mealColors = ['#2E8B57', '#FF6347', '#4169E1', '#FFD700', '#8A2BE2', '#FF1493', '#00CED1', '#32CD32', '#FF4500', '#9932CC'];
const symptomColors = ['#DC143C', '#FF69B4', '#8B0000', '#B22222', '#CD5C5C', '#F08080', '#FA8072', '#E9967A', '#FFA07A', '#FF6347'];

function updateCharts() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const tau = document.getElementById('tau').value;
    
    if (!startDate || !endDate) {
        alert('Vennligst velg bÃ¥de start- og sluttdato');
        return;
    }
    
    // Show loading state
    document.getElementById('meal-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    document.getElementById('symptom-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    document.getElementById('combined-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    
    fetch(`/timeseries/data?start=${startDate}&end=${endDate}&tau=${tau}`)
        .then(response => response.json())
        .then(data => {
            // data: array of {meal_type, symptom_type, lags, corr}
            // Bygg opp et sett av alle meal_types og symptom_types
            const mealTypes = new Set();
            const symptomTypes = new Set();
            for (const entry of data) {
                mealTypes.add(entry.meal_type);
                symptomTypes.add(entry.symptom_type);
            }

            // MÃ¥ltid vs symptom: ett plot per par
            // 1. MÃ¥ltidstype mot alle symptomtyper
            document.getElementById('meal-chart').innerHTML = '';
            let mealPlots = [];
            let mealColorIndex = 0;
            for (const mealType of mealTypes) {
                const traces = [];
                let localMax = 0;
                let localMin = 0;
                let colorIdx = 0;
                for (const symptomType of symptomTypes) {
                    const entry = data.find(e => e.meal_type === mealType && e.symptom_type === symptomType);
                    if (!entry) continue;
                    const lags = entry.lags.map(l => l / 60); // minutter til timer
                    const corr = entry.corr;
                    const maxCorr = Math.max(...corr);
                    const minCorr = Math.min(...corr);
                    if (maxCorr > localMax) localMax = maxCorr;
                    if (minCorr < localMin) localMin = minCorr;
                    traces.push({
                        x: lags,
                        y: corr,
                        type: 'scatter',
                        mode: 'lines',
                        name: symptomType,
                        line: { 
                            color: symptomColors[colorIdx % symptomColors.length], 
                            width: 2 
                        }
                    });
                    colorIdx++;
                }
                if (traces.length > 0) {
                    const layout = {
                        title: `Krysskorrelasjon: ${mealType} vs symptomer`,
                        xaxis: { title: 'Forsinkelse (timer)', zeroline: true },
                        yaxis: { title: 'Krysskorrelasjon', range: [localMin-0.05, localMax+0.05] },
                        margin: { t: 50, r: 50, b: 50, l: 80 },
                        legend: { orientation: 'h', y: -0.2 }
                    };
                    const divId = `meal-cc-${mealColorIndex}`;
                    const div = document.createElement('div');
                    div.id = divId;
                    div.style.height = '400px';
                    document.getElementById('meal-chart').appendChild(div);
                    Plotly.newPlot(divId, traces, layout, {responsive: true});
                    mealColorIndex++;
                }
            }

            // 2. Symptomtype mot alle mÃ¥ltidstyper
            document.getElementById('symptom-chart').innerHTML = '';
            let symptomPlots = [];
            let symptomColorIndex = 0;
            for (const symptomType of symptomTypes) {
                const traces = [];
                let localMax = 0;
                let localMin = 0;
                let colorIdx = 0;
                for (const mealType of mealTypes) {
                    const entry = data.find(e => e.meal_type === mealType && e.symptom_type === symptomType);
                    if (!entry) continue;
                    const lags = entry.lags.map(l => l / 60);
                    const corr = entry.corr;
                    const maxCorr = Math.max(...corr);
                    const minCorr = Math.min(...corr);
                    if (maxCorr > localMax) localMax = maxCorr;
                    if (minCorr < localMin) localMin = minCorr;
                    traces.push({
                        x: lags,
                        y: corr,
                        type: 'scatter',
                        mode: 'lines',
                        name: mealType,
                        line: { 
                            color: mealColors[colorIdx % mealColors.length], 
                            width: 2 
                        }
                    });
                    colorIdx++;
                }
                if (traces.length > 0) {
                    const layout = {
                        title: `Krysskorrelasjon: ${symptomType} vs mÃ¥ltider`,
                        xaxis: { title: 'Forsinkelse (timer)', zeroline: true },
                        yaxis: { title: 'Krysskorrelasjon', range: [localMin-0.05, localMax+0.05] },
                        margin: { t: 50, r: 50, b: 50, l: 80 },
                        legend: { orientation: 'h', y: -0.2 }
                    };
                    const divId = `symptom-cc-${symptomColorIndex}`;
                    const div = document.createElement('div');
                    div.id = divId;
                    div.style.height = '400px';
                    document.getElementById('symptom-chart').appendChild(div);
                    Plotly.newPlot(divId, traces, layout, {responsive: true});
                    symptomColorIndex++;
                }
            }

            // 3. Kombinert: alle par
            document.getElementById('combined-chart').innerHTML = '';
            const combinedTraces = [];
            let combinedColorIndex = 0;
            for (const entry of data) {
                const lags = entry.lags.map(l => l / 60);
                combinedTraces.push({
                    x: lags,
                    y: entry.corr,
                    type: 'scatter',
                    mode: 'lines',
                    name: `${entry.meal_type} â†’ ${entry.symptom_type}`,
                    line: { 
                        color: mealColors[combinedColorIndex % mealColors.length], 
                        width: 2 
                    }
                });
                combinedColorIndex++;
            }
            if (combinedTraces.length > 0) {
                const layout = {
                    title: 'Krysskorrelasjon: alle mÃ¥ltidstyper og symptomtyper',
                    xaxis: { title: 'Forsinkelse (timer)', zeroline: true },
                    yaxis: { title: 'Krysskorrelasjon' },
                    margin: { t: 50, r: 50, b: 100, l: 80 },
                    legend: { orientation: 'h', y: -0.3 }
                };
                Plotly.newPlot('combined-chart', combinedTraces, layout, {responsive: true});
            } else {
                document.getElementById('combined-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Ingen data funnet for valgt periode</div>';
            }
        })
        .catch(error => {
            console.error('Feil ved henting av data:', error);
            alert('Feil ved henting av data. Se konsollen for detaljer.');
        });
}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCharts();
});

// Update charts when button is clicked
document.getElementById('update-chart').addEventListener('click', updateCharts);
</script>
</body>
</html>
