<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsserier - Mat- og Symptombok</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/plotly.min.js"></script>
</head>
<body>
<nav>
    <div class="container">
        <a href="/">🏠 Hjem</a>
        <a href="/report">📊 Rapport</a>
        <a href="/crosscorr">🔗 Krysskorrelasjon</a>
        <a href="/meal-symptom-analysis">📈 Analyse</a>
        <a href="/timeseries" class="active">⏱️ Tidsserier</a>
    </div>
</nav>

<div class="container">
    <h1>⏱️ Tidsserier for Hendelser</h1>
    <p>Visualisering av måltider og symptomer som tidsfunksjoner. Y-aksen viser 1 når hendelsen skjer og 0 ellers.</p>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">📅 Velg tidsperiode</h2>
        </div>
        <div class="form-group">
            <label for="start-date">Startdato:</label>
            <input type="date" id="start-date" value="{{ .Start }}">
        </div>
        <div class="form-group">
            <label for="end-date">Sluttdato:</label>
            <input type="date" id="end-date" value="{{ .End }}">
        </div>
        <button id="update-chart" class="btn btn-primary">🔄 Oppdater diagram</button>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">🍽️ Måltider - Tidsserie</h2>
        </div>
        <div id="meal-chart" style="height: 400px;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">🤒 Symptomer - Tidsserie</h2>
        </div>
        <div id="symptom-chart" style="height: 400px;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">📊 Kombinert visning</h2>
        </div>
        <div id="combined-chart" style="height: 500px;"></div>
    </div>
</div>

<script>
function updateCharts() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
        alert('Vennligst velg både start- og sluttdato');
        return;
    }
    
    // Show loading state
    document.getElementById('meal-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    document.getElementById('symptom-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    document.getElementById('combined-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    
    fetch(`/timeseries/data?start=${startDate}&end=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Prepare data for Plotly
            const mealTimes = data.meal_series.map(point => point.time);
            const mealValues = data.meal_series.map(point => point.value);
            const symptomTimes = data.symptom_series.map(point => point.time);
            const symptomValues = data.symptom_series.map(point => point.value);
            
            // Meal chart
            const mealTrace = {
                x: mealTimes,
                y: mealValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Måltider',
                line: { color: '#2E8B57', width: 1 },
                fill: 'tozeroy',
                fillcolor: 'rgba(46, 139, 87, 0.3)'
            };
            
            const mealLayout = {
                title: 'Måltider over tid',
                xaxis: { 
                    title: 'Tid',
                    type: 'date'
                },
                yaxis: { 
                    title: 'Hendelse (1 = måltid, 0 = ingen)',
                    range: [-0.1, 1.1],
                    dtick: 1
                },
                margin: { t: 50, r: 50, b: 50, l: 80 }
            };
            
            Plotly.newPlot('meal-chart', [mealTrace], mealLayout, {responsive: true});
            
            // Symptom chart
            const symptomTrace = {
                x: symptomTimes,
                y: symptomValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Symptomer',
                line: { color: '#DC143C', width: 1 },
                fill: 'tozeroy',
                fillcolor: 'rgba(220, 20, 60, 0.3)'
            };
            
            const symptomLayout = {
                title: 'Symptomer over tid',
                xaxis: { 
                    title: 'Tid',
                    type: 'date'
                },
                yaxis: { 
                    title: 'Hendelse (1 = symptom, 0 = ingen)',
                    range: [-0.1, 1.1],
                    dtick: 1
                },
                margin: { t: 50, r: 50, b: 50, l: 80 }
            };
            
            Plotly.newPlot('symptom-chart', [symptomTrace], symptomLayout, {responsive: true});
            
            // Combined chart
            const combinedLayout = {
                title: 'Måltider og symptomer - kombinert visning',
                xaxis: { 
                    title: 'Tid',
                    type: 'date'
                },
                yaxis: { 
                    title: 'Hendelse',
                    range: [-0.1, 2.1],
                    tickvals: [0, 1, 2],
                    ticktext: ['Ingen', 'Måltid/Symptom', 'Begge']
                },
                margin: { t: 50, r: 50, b: 50, l: 80 }
            };
            
            // Create combined data (meals at y=1, symptoms at y=2)
            const mealTraceShifted = {
                x: mealTimes,
                y: mealValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Måltider',
                line: { color: '#2E8B57', width: 2 },
                fill: 'tozeroy',
                fillcolor: 'rgba(46, 139, 87, 0.3)'
            };
            
            const symptomTraceShifted = {
                x: symptomTimes,
                y: symptomValues.map(v => v * 2), // Shift symptoms to y=2
                type: 'scatter',
                mode: 'lines',
                name: 'Symptomer',
                line: { color: '#DC143C', width: 2 },
                fill: 'tonexty',
                fillcolor: 'rgba(220, 20, 60, 0.3)'
            };
            
            Plotly.newPlot('combined-chart', [mealTraceShifted, symptomTraceShifted], combinedLayout, {responsive: true});
        })
        .catch(error => {
            console.error('Feil ved henting av data:', error);
            alert('Feil ved henting av data. Se konsollen for detaljer.');
        });
}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCharts();
});

// Update charts when button is clicked
document.getElementById('update-chart').addEventListener('click', updateCharts);
</script>
</body>
</html>