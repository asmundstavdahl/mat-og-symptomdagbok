<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsserier - Mat- og Symptombok</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/plotly.min.js"></script>
</head>
<body>
<nav>
    <div class="container">
        <a href="/">ğŸ  Hjem</a>
        <a href="/report">ğŸ“Š Rapport</a>
        <a href="/crosscorr">ğŸ”— Krysskorrelasjon</a>
        <a href="/meal-symptom-analysis">ğŸ“ˆ Analyse</a>
        <a href="/timeseries" class="active">â±ï¸ Tidsserier</a>
    </div>
</nav>

<div class="container">
    <h1>â±ï¸ Tidsserier for Hendelser</h1>
    <p>Visualisering av mÃ¥ltider og symptomer som tidsfunksjoner. Y-aksen viser 1 nÃ¥r hendelsen skjer og 0 ellers.</p>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ“… Velg tidsperiode</h2>
        </div>
        <div class="form-group">
            <label for="start-date">Startdato:</label>
            <input type="date" id="start-date" value="{{ .Start }}">
        </div>
        <div class="form-group">
            <label for="end-date">Sluttdato:</label>
            <input type="date" id="end-date" value="{{ .End }}">
        </div>
        <div class="form-group">
            <label for="tau">Tidskonstant (minutter, lavpassfilter):</label>
            <input type="number" id="tau" min="1" max="240" value="10" style="width: 80px;">
        </div>
        <button id="update-chart" class="btn btn-primary">ğŸ”„ Oppdater diagram</button>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ½ï¸ MÃ¥ltider - Tidsserie (etter type)</h2>
        </div>
        <div id="meal-chart" style="height: 500px;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ¤’ Symptomer - Tidsserie (etter type)</h2>
        </div>
        <div id="symptom-chart" style="height: 500px;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ“Š Kombinert visning - Alle typer</h2>
        </div>
        <div id="combined-chart" style="height: 600px;"></div>
    </div>
</div>

<script>
// Color palettes for different types
const mealColors = ['#2E8B57', '#FF6347', '#4169E1', '#FFD700', '#8A2BE2', '#FF1493', '#00CED1', '#32CD32', '#FF4500', '#9932CC'];
const symptomColors = ['#DC143C', '#FF69B4', '#8B0000', '#B22222', '#CD5C5C', '#F08080', '#FA8072', '#E9967A', '#FFA07A', '#FF6347'];

function updateCharts() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const tau = document.getElementById('tau').value;
    
    if (!startDate || !endDate) {
        alert('Vennligst velg bÃ¥de start- og sluttdato');
        return;
    }
    
    // Show loading state
    document.getElementById('meal-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    document.getElementById('symptom-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    document.getElementById('combined-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Laster data...</div>';
    
    fetch(`/timeseries/data?start=${startDate}&end=${endDate}&tau=${tau}`)
        .then(response => response.json())
        .then(data => {
            // Create meal chart with separate traces for each meal type
            const mealTraces = [];
            let mealColorIndex = 0;
            
            for (const [mealType, series] of Object.entries(data.meal_series_by_type || {})) {
                const times = series.map(point => point.time);
                const values = series.map(point => point.value);
                
                mealTraces.push({
                    x: times,
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: mealType,
                    line: { 
                        color: mealColors[mealColorIndex % mealColors.length], 
                        width: 2 
                    },
                    fill: 'tozeroy',
                    fillcolor: mealColors[mealColorIndex % mealColors.length].replace(')', ', 0.3)').replace('rgb', 'rgba')
                });
                mealColorIndex++;
            }
            
            const mealLayout = {
                title: 'MÃ¥ltider over tid - etter type',
                xaxis: { 
                    title: 'Tid',
                    type: 'date'
                },
                yaxis: { 
                    title: 'Hendelse (1 = mÃ¥ltid, 0 = ingen)',
                    range: [-0.1, 1.1],
                    dtick: 1
                },
                margin: { t: 50, r: 50, b: 50, l: 80 },
                legend: { 
                    orientation: 'h',
                    y: -0.2
                }
            };
            
            if (mealTraces.length > 0) {
                Plotly.newPlot('meal-chart', mealTraces, mealLayout, {responsive: true});
            } else {
                document.getElementById('meal-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Ingen mÃ¥ltidsdata funnet for valgt periode</div>';
            }
            
            // Create symptom chart with separate traces for each symptom type
            const symptomTraces = [];
            let symptomColorIndex = 0;
            
            for (const [symptomType, series] of Object.entries(data.symptom_series_by_type || {})) {
                const times = series.map(point => point.time);
                const values = series.map(point => point.value);
                
                symptomTraces.push({
                    x: times,
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: symptomType,
                    line: { 
                        color: symptomColors[symptomColorIndex % symptomColors.length], 
                        width: 2 
                    },
                    fill: 'tozeroy',
                    fillcolor: symptomColors[symptomColorIndex % symptomColors.length].replace(')', ', 0.3)').replace('rgb', 'rgba')
                });
                symptomColorIndex++;
            }
            
            const symptomLayout = {
                title: 'Symptomer over tid - etter type',
                xaxis: { 
                    title: 'Tid',
                    type: 'date'
                },
                yaxis: { 
                    title: 'Hendelse (1 = symptom, 0 = ingen)',
                    range: [-0.1, 1.1],
                    dtick: 1
                },
                margin: { t: 50, r: 50, b: 50, l: 80 },
                legend: { 
                    orientation: 'h',
                    y: -0.2
                }
            };
            
            if (symptomTraces.length > 0) {
                Plotly.newPlot('symptom-chart', symptomTraces, symptomLayout, {responsive: true});
            } else {
                document.getElementById('symptom-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Ingen symptomdata funnet for valgt periode</div>';
            }
            
            // Create combined chart with all types
            const combinedTraces = [];
            let combinedColorIndex = 0;
            
            // Add meal traces
            for (const [mealType, series] of Object.entries(data.meal_series_by_type || {})) {
                const times = series.map(point => point.time);
                const values = series.map(point => point.value);
                
                combinedTraces.push({
                    x: times,
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: `ğŸ½ï¸ ${mealType}`,
                    line: { 
                        color: mealColors[combinedColorIndex % mealColors.length], 
                        width: 2 
                    },
                    fill: 'tozeroy',
                    fillcolor: mealColors[combinedColorIndex % mealColors.length].replace(')', ', 0.2)').replace('rgb', 'rgba')
                });
                combinedColorIndex++;
            }
            
            // Add symptom traces (shifted to y=1.5 level for better visibility)
            combinedColorIndex = 0;
            for (const [symptomType, series] of Object.entries(data.symptom_series_by_type || {})) {
                const times = series.map(point => point.time);
                const values = series.map(point => point.value * 1.5); // Shift to 1.5 level
                
                combinedTraces.push({
                    x: times,
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: `ğŸ¤’ ${symptomType}`,
                    line: { 
                        color: symptomColors[combinedColorIndex % symptomColors.length], 
                        width: 2 
                    },
                    fill: 'tozeroy',
                    fillcolor: symptomColors[combinedColorIndex % symptomColors.length].replace(')', ', 0.2)').replace('rgb', 'rgba')
                });
                combinedColorIndex++;
            }
            
            const combinedLayout = {
                title: 'MÃ¥ltider og symptomer - alle typer kombinert',
                xaxis: { 
                    title: 'Tid',
                    type: 'date'
                },
                yaxis: { 
                    title: 'Hendelse',
                    range: [-0.1, 1.6],
                    tickvals: [0, 1, 1.5],
                    ticktext: ['Ingen', 'MÃ¥ltid', 'Symptom']
                },
                margin: { t: 50, r: 50, b: 100, l: 80 },
                legend: { 
                    orientation: 'h',
                    y: -0.3
                }
            };
            
            if (combinedTraces.length > 0) {
                Plotly.newPlot('combined-chart', combinedTraces, combinedLayout, {responsive: true});
            } else {
                document.getElementById('combined-chart').innerHTML = '<div style="text-align: center; padding: 50px;">Ingen data funnet for valgt periode</div>';
            }
        })
        .catch(error => {
            console.error('Feil ved henting av data:', error);
            alert('Feil ved henting av data. Se konsollen for detaljer.');
        });
}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCharts();
});

// Update charts when button is clicked
document.getElementById('update-chart').addEventListener('click', updateCharts);
</script>
</body>
</html>
